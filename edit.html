<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notioné¢¨Wiki</title>
    <!-- æ–°ã—ã„Google Identity Services API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #fff;
            color: #37352f;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 240px;
            background: #f7f6f3;
            border-right: 1px solid #e9e9e7;
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #e9e9e7;
            margin-bottom: 20px;
        }
        
        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #37352f;
        }
        
        .page-list {
            list-style: none;
        }
        
        .page-item {
            padding: 8px 20px;
            cursor: pointer;
            font-size: 14px;
            color: #37352f;
            transition: background 0.1s;
            border-radius: 4px;
            margin: 2px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-item:hover {
            background: #e9e9e7;
        }
        
        .page-item.active {
            background: #2383e2;
            color: white;
        }
        
        .page-item-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            height: 60px;
            border-bottom: 1px solid #e9e9e7;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid #d3d2ce;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.1s;
            font-weight: 500;
        }
        
        .btn:hover {
            background: #f7f6f3;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #2383e2;
            color: white;
            border-color: #2383e2;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #1a6bc2;
        }
        
        .editor-container {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }
        
        .editor {
            max-width: 700px;
            margin: 0 auto;
        }
        
        .page-title {
            font-size: 40px;
            font-weight: 700;
            border: none;
            outline: none;
            width: 100%;
            margin-bottom: 20px;
            color: #37352f;
            background: transparent;
        }
        
        .page-title::placeholder {
            color: #9b9a97;
        }
        
        .editor-content {
            font-size: 16px;
            line-height: 1.6;
            border: none;
            outline: none;
            width: 100%;
            min-height: 400px;
            resize: vertical;
            font-family: inherit;
            background: transparent;
        }
        
        .editor-content::placeholder {
            color: #9b9a97;
        }
        
        .viewer-content {
            font-size: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 20px;
            text-align: center;
        }
        
        .login-container h1 {
            color: #37352f;
            font-weight: 700;
        }
        
        .login-container p {
            color: #9b9a97;
            max-width: 400px;
        }
        
        .status-message {
            padding: 12px 20px;
            margin: 0 20px 10px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .new-page-form {
            display: flex;
            gap: 8px;
            padding: 20px;
            border-top: 1px solid #e9e9e7;
        }
        
        .new-page-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d3d2ce;
            border-radius: 4px;
            font-size: 13px;
            outline: none;
        }
        
        .new-page-input:focus {
            border-color: #2383e2;
        }
        
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 20px;
            text-align: center;
            color: #9b9a97;
        }
        
        .welcome-screen h2 {
            color: #37352f;
            font-weight: 600;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2383e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .config-notice {
            background: #fff3cd;
            color: #856404;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
            max-width: 600px;
        }
        
        .config-notice strong {
            display: block;
            margin-bottom: 10px;
        }
        
        .config-notice code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 10px;
            font-size: 12px;
            color: #666;
        }
        
        .user-info img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e9e9e7;
            }
            
            .editor-container {
                padding: 20px;
            }
            
            .page-title {
                font-size: 32px;
            }
            
            .user-info {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-container" style="display: flex; align-items: center; justify-content: center; height: 100vh; gap: 10px;">
            <div class="loading-spinner"></div>
            <span>åˆæœŸåŒ–ä¸­...</span>
        </div>
    </div>
    
    <!-- Google Sign-In button container -->
    <div id="g_id_signin" style="display: none;"></div>

    <script>
        // è¨­å®š - å®Ÿéš›ã®ä½¿ç”¨æ™‚ã¯è‡ªåˆ†ã®å€¤ã«å¤‰æ›´ã—ã¦ãã ã•ã„
        const CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxzq-iDY4y5wyFV2bvaReNJ1N4fv_0xcqPn4zNYBdwUGI5QR8HKc0TcxA11thIgJL4z8g/exec',
            CLIENT_ID: '680055548295-hv2bpt4untk1agai47l5c33p7hdp6hro.apps.googleusercontent.com',
            // é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
            DEMO_MODE: false
        };

        class WikiApp {
            constructor() {
                this.state = {
                    isAuthenticated: false,
                    accessToken: null,
                    userInfo: null,
                    pages: [],
                    currentPage: null,
                    isEditing: false,
                    title: '',
                    content: '',
                    statusMessage: '',
                    newPageTitle: '',
                    loading: false,
                    initialized: false
                };
                
                this.init();
            }
            
            async init() {
                try {
                    if (CONFIG.DEMO_MODE) {
                        // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨
                        this.initLocalStorage();
                        this.setState({ 
                            isAuthenticated: true, 
                            initialized: true 
                        });
                        await this.loadPages();
                    } else {
                        // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ï¼šGoogleèªè¨¼ã‚’ä½¿ç”¨
                        await this.initGoogleAuth();
                        this.setState({ initialized: true });
                    }
                } catch (error) {
                    console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    this.setState({ 
                        statusMessage: 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
                        initialized: true 
                    });
                }
                
                this.render();
            }
            
            initLocalStorage() {
                const storageKey = 'notion-wiki-pages';
                if (!localStorage.getItem(storageKey)) {
                    const defaultPages = [
                        {
                            id: '1',
                            title: 'ã¯ã˜ã‚ã« - Google Apps Scriptçµ±åˆã‚¬ã‚¤ãƒ‰',
                            content: `# Notioné¢¨Wiki - Google Apps Scriptçµ±åˆã‚¬ã‚¤ãƒ‰

ã“ã®Wikiã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Google Apps Scriptã¨çµ±åˆã™ã‚‹ãŸã‚ã®å®Œå…¨ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚

## ğŸš€ ç¾åœ¨ã®çŠ¶æ…‹
- âœ… **ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰**: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§å‹•ä½œä¸­
- ğŸ”„ **çµ±åˆæº–å‚™å®Œäº†**: Apps Scriptã¨ã®é€£æºå¯èƒ½

## ğŸ“‹ çµ±åˆæ‰‹é †

### 1. Google Apps Scriptã®æº–å‚™

#### 1-1. æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
1. [Google Apps Script](https://script.google.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã€Œæ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’ã€ŒNotioné¢¨Wiki APIã€ã«å¤‰æ›´

#### 1-2. æä¾›ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
æä¾›ã•ã‚ŒãŸ Apps Script ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š
- doGeté–¢æ•°
- doPosté–¢æ•° 
- getOrCreateSpreadsheeté–¢æ•°
- ãã®ä»–ã™ã¹ã¦ã®é–¢æ•°

#### 1-3. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’è¨­å®š
\`\`\`javascript
const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE';
\`\`\`

### 2. Google Cloudã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®š

#### 2-1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
1. [Google Cloud Console](https://console.cloud.google.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: ã€ŒNotion Wikiã€

#### 2-2. APIã®æœ‰åŠ¹åŒ–
ä»¥ä¸‹ã®APIã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ï¼š
- Google Sheets API
- Google Drive API

#### 2-3. OAuth2.0ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDä½œæˆ
1. ã€Œèªè¨¼æƒ…å ±ã€â†’ã€Œèªè¨¼æƒ…å ±ã‚’ä½œæˆã€â†’ã€ŒOAuth ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€
2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¨®é¡: ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€
3. æ‰¿èªæ¸ˆã¿JavaScriptã‚ªãƒªã‚¸ãƒ³: 
   - \`http://localhost:8000\` (é–‹ç™ºç”¨)
   - \`https://yourusername.github.io\` (æœ¬ç•ªç”¨)
4. ç”Ÿæˆã•ã‚ŒãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’ãƒ¡ãƒ¢

### 3. Apps Scriptãƒ‡ãƒ—ãƒ­ã‚¤

#### 3-1. Webã‚¢ãƒ—ãƒªã¨ã—ã¦å…¬é–‹
1. ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã€
2. ç¨®é¡: ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€
3. å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œè‡ªåˆ†ã€
4. ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€
5. ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
6. ç”Ÿæˆã•ã‚ŒãŸURLã‚’ãƒ¡ãƒ¢

### 4. ã“ã®ã‚¢ãƒ—ãƒªã®è¨­å®š

\`\`\`javascript
const CONFIG = {
    APPS_SCRIPT_URL: 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec',
    CLIENT_ID: 'YOUR_GOOGLE_CLIENT_ID',
    DEMO_MODE: false  // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´
};
\`\`\`

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ
1. **CORS ã‚¨ãƒ©ãƒ¼**: Apps Scriptã®ã€Œã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€è¨­å®šã‚’ç¢ºèª
2. **èªè¨¼ã‚¨ãƒ©ãƒ¼**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚ªãƒªã‚¸ãƒ³URLã‚’ç¢ºèª
3. **ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼**: IDãŒæ­£ã—ã„ã‹ç¢ºèª

### ãƒ†ã‚¹ãƒˆæ–¹æ³•
1. Apps Scriptã§testAPI()é–¢æ•°ã‚’å®Ÿè¡Œ
2. ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã‚’ç¢ºèª
3. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯

## ğŸ“ˆ ä»Šå¾Œã®æ©Ÿèƒ½æ‹¡å¼µ

çµ±åˆå®Œäº†å¾Œã€ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’è¿½åŠ äºˆå®šï¼š
- ğŸ” å…¨æ–‡æ¤œç´¢
- ğŸ·ï¸ ã‚¿ã‚°æ©Ÿèƒ½
- ğŸ“ Markdownãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
- ğŸ“Š ç·¨é›†å±¥æ­´
- ğŸ‘¥ ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†æ¨©é™

çµ±åˆã«é–¢ã™ã‚‹è³ªå•ãŒã‚ã‚Œã°ã€GitHubã®Issuesã§ãŠæ°—è»½ã«ãŠèããã ã•ã„ï¼`,
                            updatedAt: new Date().toISOString()
                        }
                    ];
                    localStorage.setItem(storageKey, JSON.stringify(defaultPages));
                }
            }
            
            async initGoogleAuth() {
                return new Promise((resolve) => {
                    // Google Identity Services ã®åˆæœŸåŒ–
                    window.google.accounts.id.initialize({
                        client_id: CONFIG.CLIENT_ID,
                        callback: (response) => {
                            this.handleCredentialResponse(response);
                        }
                    });

                    // OAuth2 ã®åˆæœŸåŒ–
                    this.tokenClient = window.google.accounts.oauth2.initTokenClient({
                        client_id: CONFIG.CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/spreadsheets',
                        callback: (tokenResponse) => {
                            this.handleTokenResponse(tokenResponse);
                        }
                    });

                    resolve();
                });
            }
            
            handleCredentialResponse(response) {
                // JWTãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                const credential = this.parseJwt(response.credential);
                
                this.setState({
                    userInfo: {
                        name: credential.name,
                        email: credential.email,
                        picture: credential.picture
                    }
                });
                
                // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                this.tokenClient.requestAccessToken();
            }
            
            handleTokenResponse(tokenResponse) {
                if (tokenResponse.access_token) {
                    this.setState({
                        isAuthenticated: true,
                        accessToken: tokenResponse.access_token
                    });
                    this.loadPages();
                }
            }
            
            parseJwt(token) {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            }
            
            setState(newState) {
                this.state = { ...this.state, ...newState };
                if (this.state.initialized) {
                    this.render();
                }
            }
            
            async loadPages() {
                this.setState({ loading: true, statusMessage: 'ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ä¸­...' });
                
                try {
                    let pages;
                    if (CONFIG.DEMO_MODE) {
                        const storageKey = 'notion-wiki-pages';
                        pages = JSON.parse(localStorage.getItem(storageKey) || '[]');
                        pages.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                    } else {
                        const result = await this.apiCall('getPages');
                        pages = result.pages || [];
                    }
                    
                    this.setState({ 
                        pages, 
                        loading: false,
                        statusMessage: pages.length > 0 ? `${pages.length}å€‹ã®ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ` : 'ãƒšãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“'
                    });
                    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’3ç§’å¾Œã«æ¶ˆå»
                    setTimeout(() => {
                        this.setState({ statusMessage: '' });
                    }, 3000);
                    
                } catch (error) {
                    console.error('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    this.setState({ 
                        statusMessage: 'ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message,
                        loading: false 
                    });
                }
            }
            
            async loadPage(pageId) {
                this.setState({ loading: true });
                
                try {
                    let page;
                    if (CONFIG.DEMO_MODE) {
                        const pages = JSON.parse(localStorage.getItem('notion-wiki-pages') || '[]');
                        page = pages.find(p => p.id === pageId);
                    } else {
                        const result = await this.apiCall('getPage', 'GET', { id: pageId });
                        page = result.page;
                    }
                    
                    if (page) {
                        this.setState({
                            currentPage: page,
                            title: page.title || '',
                            content: page.content || '',
                            isEditing: false,
                            loading: false
                        });
                    } else {
                        this.setState({
                            statusMessage: 'ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ',
                            loading: false
                        });
                    }
                } catch (error) {
                    console.error('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    this.setState({ 
                        statusMessage: 'ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message,
                        loading: false 
                    });
                }
            }
            
            async savePage() {
                const { title, content, currentPage } = this.state;
                this.setState({ loading: true, statusMessage: 'ä¿å­˜ä¸­...' });
                
                try {
                    const pageData = {
                        id: currentPage?.id || Date.now().toString(),
                        title: title.trim() || 'ç„¡é¡Œ',
                        content: content
                    };
                    
                    if (CONFIG.DEMO_MODE) {
                        const pages = JSON.parse(localStorage.getItem('notion-wiki-pages') || '[]');
                        const existingIndex = pages.findIndex(p => p.id === pageData.id);
                        
                        const updatedPage = {
                            ...pageData,
                            updatedAt: new Date().toISOString()
                        };
                        
                        if (existingIndex >= 0) {
                            pages[existingIndex] = updatedPage;
                        } else {
                            pages.push(updatedPage);
                        }
                        
                        localStorage.setItem('notion-wiki-pages', JSON.stringify(pages));
                        
                        this.setState({
                            currentPage: updatedPage,
                            isEditing: false,
                            statusMessage: 'ä¿å­˜ã—ã¾ã—ãŸ',
                            loading: false
                        });
                    } else {
                        const result = await this.apiCall('savePage', 'POST', pageData);
                        
                        if (result.success) {
                            this.setState({
                                statusMessage: 'ä¿å­˜ã—ã¾ã—ãŸ',
                                isEditing: false,
                                loading: false
                            });
                            
                            if (!currentPage) {
                                this.setState({ currentPage: pageData });
                            }
                        }
                    }
                    
                    await this.loadPages();
                    
                } catch (error) {
                    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    this.setState({ 
                        statusMessage: 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message,
                        loading: false 
                    });
                }
            }
            
            createNewPage() {
                const { newPageTitle } = this.state;
                if (!newPageTitle.trim()) return;
                
                this.setState({
                    currentPage: null,
                    title: newPageTitle,
                    content: '',
                    isEditing: true,
                    newPageTitle: ''
                });
            }
            
            async apiCall(endpoint, method = 'GET', data = null) {
                if (CONFIG.DEMO_MODE) {
                    throw new Error('ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§ã¯APIã‚³ãƒ¼ãƒ«ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                if (!this.state.accessToken) {
                    throw new Error('ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                }

                const url = new URL(CONFIG.APPS_SCRIPT_URL);
                url.searchParams.set('action', endpoint);
                
                const options = {
                    method,
                    headers: {
                        'Authorization': `Bearer ${this.state.accessToken}`,
                        'Content-Type': 'application/json'
                    }
                };

                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                } else if (data && method === 'GET') {
                    Object.keys(data).forEach(key => {
                        url.searchParams.set(key, data[key]);
                    });
                }

                const response = await fetch(url.toString(), options);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API ã‚¨ãƒ©ãƒ¼ (${response.status}): ${errorText}`);
                }
                
                return response.json();
            }
            
            signIn() {
                if (!CONFIG.DEMO_MODE) {
                    window.google.accounts.id.prompt();
                }
            }
            
            signOut() {
                if (!CONFIG.DEMO_MODE && this.state.accessToken) {
                    window.google.accounts.id.disableAutoSelect();
                    
                    // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–ã‚Šæ¶ˆã—
                    window.google.accounts.oauth2.revoke(this.state.accessToken, () => {
                        this.setState({
                            isAuthenticated: false,
                            accessToken: null,
                            userInfo: null,
                            pages: [],
                            currentPage: null,
                            title: '',
                            content: ''
                        });
                    });
                }
            }
            
            render() {
                const app = document.getElementById('root');
                
                if (!this.state.initialized) {
                    return; // åˆæœŸåŒ–ä¸­ã¯ä½•ã‚‚ã—ãªã„
                }
                
                if (!CONFIG.DEMO_MODE && !this.state.isAuthenticated) {
                    app.innerHTML = this.renderLoginScreen();
                    this.attachLoginListeners();
                    return;
                }
                
                app.innerHTML = `
                    <div class="app-container">
                        ${this.renderSidebar()}
                        ${this.renderMainContent()}
                    </div>
                `;
                
                this.attachEventListeners();
            }
            
            renderLoginScreen() {
                const configIssue = CONFIG.APPS_SCRIPT_URL.includes('YOUR_') || CONFIG.CLIENT_ID.includes('YOUR_');
                
                return `
                    <div class="app-container">
                        <div class="login-container">
                            ${configIssue ? `
                                <div class="config-notice">
                                    <strong>ğŸ”§ è¨­å®šãŒå¿…è¦ã§ã™</strong>
                                    <p>æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®è¨­å®šã‚’æ›´æ–°ã—ã¦ãã ã•ã„ï¼š</p>
                                    <ul style="text-align: left; margin-top: 10px;">
                                        <li><code>CONFIG.APPS_SCRIPT_URL</code> - Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤URL</li>
                                        <li><code>CONFIG.CLIENT_ID</code> - Google OAuth2.0ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID</li>
                                        <li><code>CONFIG.DEMO_MODE</code> - falseã«å¤‰æ›´</li>
                                    </ul>
                                    <p style="margin-top: 10px;">
                                        <strong>ãƒ‡ãƒ¢ã‚’è©¦ã—ãŸã„å ´åˆï¼š</strong><br>
                                        <code>CONFIG.DEMO_MODE = true</code> ã«è¨­å®šã—ã¦ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚
                                    </p>
                                </div>
                            ` : ''}
                            <h1>ğŸš€ Notioné¢¨Wiki</h1>
                            <p>Google Apps Scriptã¨çµ±åˆã•ã‚ŒãŸWikiã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚<br>ç·¨é›†ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
                            <button class="btn btn-primary" id="sign-in-btn" ${configIssue ? 'disabled' : ''}>
                                ğŸ“ Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                            </button>
                        </div>
                    </div>
                `;
            }
            
            renderSidebar() {
                const { pages, currentPage, newPageTitle } = this.state;
                
                return `
                    <div class="sidebar">
                        <div class="sidebar-header">
                            <div class="sidebar-title">ğŸ“š ãƒšãƒ¼ã‚¸ä¸€è¦§</div>
                            ${CONFIG.DEMO_MODE ? '<small style="color: #9b9a97;">ğŸ§ª ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰</small>' : '<small style="color: #9b9a97;">ğŸ”— Apps Scripté€£æº</small>'}
                        </div>
                        
                        <ul class="page-list">
                            ${pages.map(page => `
                                <li class="page-item ${currentPage?.id === page.id ? 'active' : ''}"
                                    data-page-id="${page.id}">
                                    <span class="page-item-title">${this.escapeHtml(page.title || 'ç„¡é¡Œ')}</span>
                                </li>
                            `).join('')}
                        </ul>
                        
                        <div class="new-page-form">
                            <input
                                type="text"
                                class="new-page-input"
                                placeholder="æ–°ã—ã„ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«"
                                value="${this.escapeHtml(newPageTitle)}"
                                id="new-page-input"
                            />
                            <button class="btn btn-primary" id="create-page-btn">è¿½åŠ </button>
                        </div>
                    </div>
                `;
            }
            
            renderMainContent() {
                const { statusMessage } = this.state;
                
                return `
                    <div class="main-content">
                        ${this.renderHeader()}
                        ${statusMessage ? this.renderStatusMessage() : ''}
                        ${this.renderEditor()}
                    </div>
                `;
            }
            
            renderHeader() {
                const { currentPage, isEditing, loading, userInfo } = this.state;
                
                let headerTitle = 'ğŸ“„ æ–°è¦ãƒšãƒ¼ã‚¸';
                if (currentPage) {
                    headerTitle = isEditing ? 'âœï¸ ç·¨é›†ä¸­' : `ğŸ“„ ${currentPage.title || 'ç„¡é¡Œ'}`;
                }
                
                return `
                    <div class="header">
                        <div class="header-title">
                            ${loading ? '<span class="loading-spinner" style="margin-right: 10px;"></span>' : ''}
                            ${this.escapeHtml(headerTitle)}
                        </div>
                        <div class="header-actions">
                            ${!CONFIG.DEMO_MODE && userInfo ? `
                                <div class="user-info">
                                    <img src="${userInfo.picture}" alt="${userInfo.name}">
                                    <span>${userInfo.name}</span>
                                </div>
                            ` : ''}
                            ${currentPage && !isEditing ? `
                                <button class="btn" id="edit-btn" ${loading ? 'disabled' : ''}>âœï¸ ç·¨é›†</button>
                            ` : ''}
                            ${isEditing ? `
                                <button class="btn" id="cancel-btn" ${loading ? 'disabled' : ''}>âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                <button class="btn btn-primary" id="save-btn" ${loading ? 'disabled' : ''}>
                                    ${loading ? '<span class="loading-spinner" style="margin-right: 5px;"></span>' : 'ğŸ’¾'}
                                    ä¿å­˜
                                </button>
                            ` : ''}
                            ${!CONFIG.DEMO_MODE ? `
                                <button class="btn" id="sign-out-btn">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            renderStatusMessage() {
                const { statusMessage, loading } = this.state;
                let className = 'status-success';
                
                if (statusMessage.includes('å¤±æ•—') || statusMessage.includes('ã‚¨ãƒ©ãƒ¼')) {
                    className = 'status-error';
                } else if (loading || statusMessage.includes('ä¸­...')) {
                    className = 'status-loading';
                }
                
                return `
                    <div class="status-message ${className}">
                        ${loading ? '<span class="loading-spinner" style="margin-right: 8px;"></span>' : ''}
                        ${this.escapeHtml(statusMessage)}
                    </div>
                `;
            }
            
            renderEditor() {
                const { currentPage, isEditing, title, content } = this.state;
                
                if (isEditing) {
                    return `
                        <div class="editor-container">
                            <div class="editor">
                                <input
                                    type="text"
                                    class="page-title"
                                    placeholder="ç„¡é¡Œ"
                                    value="${this.escapeHtml(title)}"
                                    id="title-input"
                                />
                                <textarea
                                    class="editor-content"
                                    placeholder="ä½•ã‹æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†...

ğŸ’¡ Tips:
- Ctrl/Cmd + S ã§ä¿å­˜
- æ”¹è¡Œã§ãƒ‘ãƒ©ã‚°ãƒ©ãƒ•åˆ†ã‘
- ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã‚’ã‚µãƒãƒ¼ãƒˆ"
                                    id="content-input"
                                >${this.escapeHtml(content)}</textarea>
                            </div>
                        </div>
                    `;
                } else if (currentPage) {
                    const formattedContent = this.formatContent(currentPage.content || 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“');
                    return `
                        <div class="editor-container">
                            <div class="editor">
                                <h1 class="page-title">${this.escapeHtml(currentPage.title || 'ç„¡é¡Œ')}</h1>
                                <div class="viewer-content">${formattedContent}</div>
                                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e9e9e7; font-size: 12px; color: #9b9a97;">
                                    ğŸ“… æœ€çµ‚æ›´æ–°: ${new Date(currentPage.updatedAt).toLocaleString('ja-JP')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="welcome-screen">
                            <h2>ğŸ‰ Notioné¢¨Wikiã¸ã‚ˆã†ã“ã</h2>
                            <p>å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ãƒšãƒ¼ã‚¸ã‚’é¸æŠã™ã‚‹ã‹ã€æ–°ã—ã„ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
                            ${CONFIG.DEMO_MODE ? `
                                <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border: 1px solid #bae6fd; max-width: 500px;">
                                    <h3 style="color: #0284c7; margin-bottom: 10px;">ğŸ§ª ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰</h3>
                                    <p style="color: #0369a1; margin: 0;">
                                        ç¾åœ¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚<br>
                                        Google Apps Scriptã¨ã®çµ±åˆæ–¹æ³•ã¯ã€Œã¯ã˜ã‚ã«ã€ãƒšãƒ¼ã‚¸ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
                                    </p>
                                </div>
                            ` : `
                                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border: 1px solid #bbf7d0; max-width: 500px;">
                                    <h3 style="color: #059669; margin-bottom: 10px;">ğŸ”— Apps Scripté€£æºãƒ¢ãƒ¼ãƒ‰</h3>
                                    <p style="color: #047857; margin: 0;">
                                        Google Sheetsã¨é€£æºã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã—ã¦ã„ã¾ã™ã€‚<br>
                                        è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®ç·¨é›†ãŒå¯èƒ½ã§ã™ã€‚
                                    </p>
                                </div>
                            `}
                        </div>
                    `;
                }
            }
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç°¡å˜ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå°†æ¥ã®Markdownå¯¾å¿œã¸ã®æº–å‚™ï¼‰
            formatContent(content) {
                return content
                    .split('\n')
                    .map(line => {
                        // è¦‹å‡ºã—
                        if (line.startsWith('# ')) {
                            return `<h1 style="font-size: 32px; font-weight: 700; margin: 24px 0 16px; color: #37352f;">${this.escapeHtml(line.substring(2))}</h1>`;
                        }
                        if (line.startsWith('## ')) {
                            return `<h2 style="font-size: 24px; font-weight: 600; margin: 20px 0 12px; color: #37352f;">${this.escapeHtml(line.substring(3))}</h2>`;
                        }
                        if (line.startsWith('### ')) {
                            return `<h3 style="font-size: 18px; font-weight: 600; margin: 16px 0 8px; color: #37352f;">${this.escapeHtml(line.substring(4))}</h3>`;
                        }
                        
                        // ç©ºè¡Œ
                        if (line.trim() === '') {
                            return '<br>';
                        }
                        
                        // é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆ
                        return `<p style="margin: 8px 0; line-height: 1.6;">${this.escapeHtml(line)}</p>`;
                    })
                    .join('');
            }
            
            attachLoginListeners() {
                const signInBtn = document.getElementById('sign-in-btn');
                if (signInBtn && !signInBtn.disabled) {
                    signInBtn.addEventListener('click', () => this.signIn());
                }
            }
            
            attachEventListeners() {
                // ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆã®ã‚¯ãƒªãƒƒã‚¯
                document.querySelectorAll('.page-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const pageId = item.dataset.pageId;
                        if (!this.state.loading) {
                            this.loadPage(pageId);
                        }
                    });
                });
                
                // æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆ
                const newPageInput = document.getElementById('new-page-input');
                const createBtn = document.getElementById('create-page-btn');
                
                if (newPageInput) {
                    newPageInput.addEventListener('input', (e) => {
                        this.setState({ newPageTitle: e.target.value });
                    });
                    
                    newPageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !this.state.loading) {
                            this.createNewPage();
                        }
                    });
                }
                
                if (createBtn) {
                    createBtn.addEventListener('click', () => {
                        if (!this.state.loading) {
                            this.createNewPage();
                        }
                    });
                }
                
                // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼é–¢é€£
                const titleInput = document.getElementById('title-input');
                const contentInput = document.getElementById('content-input');
                const editBtn = document.getElementById('edit-btn');
                const saveBtn = document.getElementById('save-btn');
                const cancelBtn = document.getElementById('cancel-btn');
                const signOutBtn = document.getElementById('sign-out-btn');
                
                if (titleInput) {
                    titleInput.addEventListener('input', (e) => {
                        this.setState({ title: e.target.value });
                    });
                }
                
                if (contentInput) {
                    contentInput.addEventListener('input', (e) => {
                        this.setState({ content: e.target.value });
                    });
                    
                    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
                    contentInput.addEventListener('input', function() {
                        this.style.height = 'auto';
                        this.style.height = Math.max(400, this.scrollHeight) + 'px';
                    });
                }
                
                if (editBtn) {
                    editBtn.addEventListener('click', () => {
                        if (!this.state.loading) {
                            this.setState({ isEditing: true });
                        }
                    });
                }
                
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        if (!this.state.loading) {
                            this.savePage();
                        }
                    });
                }
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        if (!this.state.loading) {
                            const { currentPage } = this.state;
                            if (currentPage) {
                                this.setState({
                                    isEditing: false,
                                    title: currentPage.title || '',
                                    content: currentPage.content || ''
                                });
                            } else {
                                this.setState({
                                    isEditing: false,
                                    title: '',
                                    content: '',
                                    currentPage: null
                                });
                            }
                        }
                    });
                }
                
                if (signOutBtn) {
                    signOutBtn.addEventListener('click', () => this.signOut());
                }
                
                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        if (this.state.isEditing && !this.state.loading) {
                            this.savePage();
                        }
                    }
                });
                
                // æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®è­¦å‘Š
                window.addEventListener('beforeunload', (e) => {
                    if (this.state.isEditing && (this.state.title !== (this.state.currentPage?.title || '') || this.state.content !== (this.state.currentPage?.content || ''))) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
            }
            
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Google Identity Services ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–
        window.addEventListener('load', () => {
            // å°‘ã—é…å»¶ã‚’è¨­ã‘ã¦Google APIã®åˆæœŸåŒ–ã‚’å¾…ã¤
            setTimeout(() => {
                new WikiApp();
            }, 100);
        });
    </script>
</body>
</html>
