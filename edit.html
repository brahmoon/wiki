<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion風Wiki</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #fff;
            color: #37352f;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 240px;
            background: #f7f6f3;
            border-right: 1px solid #e9e9e7;
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #e9e9e7;
            margin-bottom: 20px;
        }
        
        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #37352f;
        }
        
        .page-list {
            list-style: none;
        }
        
        .page-item {
            padding: 4px 20px;
            cursor: pointer;
            font-size: 14px;
            color: #37352f;
            transition: background 0.1s;
        }
        
        .page-item:hover {
            background: #e9e9e7;
        }
        
        .page-item.active {
            background: #2383e2;
            color: white;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            height: 60px;
            border-bottom: 1px solid #e9e9e7;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 6px 12px;
            border: 1px solid #d3d2ce;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.1s;
        }
        
        .btn:hover {
            background: #f7f6f3;
        }
        
        .btn-primary {
            background: #2383e2;
            color: white;
            border-color: #2383e2;
        }
        
        .btn-primary:hover {
            background: #1a6bc2;
        }
        
        .editor-container {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }
        
        .editor {
            max-width: 700px;
            margin: 0 auto;
        }
        
        .page-title {
            font-size: 40px;
            font-weight: 700;
            border: none;
            outline: none;
            width: 100%;
            margin-bottom: 20px;
            color: #37352f;
            background: transparent;
        }
        
        .page-title::placeholder {
            color: #9b9a97;
        }
        
        .editor-content {
            font-size: 16px;
            line-height: 1.5;
            border: none;
            outline: none;
            width: 100%;
            min-height: 400px;
            resize: vertical;
            font-family: inherit;
            background: transparent;
        }
        
        .editor-content::placeholder {
            color: #9b9a97;
        }
        
        .viewer-content {
            font-size: 16px;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 20px;
        }
        
        .status-message {
            padding: 10px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .new-page-form {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #e9e9e7;
        }
        
        .new-page-input {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid #d3d2ce;
            border-radius: 4px;
            font-size: 12px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- 初期ローディング状態 -->
        <div class="app-container">
            <div class="login-container">
                <h1>Notion風Wiki</h1>
                <p>初期化中...</p>
            </div>
        </div>
    </div>

    <script>
        // 設定 - 実際の使用時は環境変数などで管理
        const CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxzq-iDY4y5wyFV2bvaReNJ1N4fv_0xcqPn4zNYBdwUGI5QR8HKc0TcxA11thIgJL4z8g/exec',
            CLIENT_ID: '680055548295-hv2bpt4untk1agai47l5c33p7hdp6hro.apps.googleusercontent.com'
        };

        // アプリケーションの状態管理
        class WikiApp {
            constructor() {
                this.isAuthenticated = false;
                this.authInstance = null;
                this.pages = [];
                this.currentPage = null;
                this.isEditing = false;
                this.title = '';
                this.content = '';
                this.statusMessage = '';
                this.newPageTitle = '';
                
                this.init();
            }

            async init() {
                try {
                    await this.initGoogleAuth();
                    this.render();
                } catch (error) {
                    console.error('初期化エラー:', error);
                    this.showError('初期化に失敗しました');
                }
            }

            async initGoogleAuth() {
                return new Promise((resolve) => {
                    gapi.load('auth2', async () => {
                        try {
                            this.authInstance = await gapi.auth2.init({
                                client_id: CONFIG.CLIENT_ID
                            });
                            
                            this.isAuthenticated = this.authInstance.isSignedIn.get();
                            
                            // サインイン状態の変更を監視
                            this.authInstance.isSignedIn.listen((isSignedIn) => {
                                this.isAuthenticated = isSignedIn;
                                if (isSignedIn) {
                                    this.loadPages();
                                }
                                this.render();
                            });

                            if (this.isAuthenticated) {
                                this.loadPages();
                            }
                            
                            resolve();
                        } catch (error) {
                            console.error('Google Auth初期化エラー:', error);
                            resolve();
                        }
                    });
                });
            }

            async apiCall(endpoint, method = 'GET', data = null) {
                if (!this.authInstance || !this.authInstance.isSignedIn.get()) {
                    throw new Error('ログインが必要です');
                }

                const token = this.authInstance.currentUser.get().getAuthResponse().access_token;
                
                const url = new URL(CONFIG.APPS_SCRIPT_URL);
                url.searchParams.set('action', endpoint);
                
                const options = {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                };

                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                } else if (data && method === 'GET') {
                    Object.keys(data).forEach(key => {
                        url.searchParams.set(key, data[key]);
                    });
                }

                const response = await fetch(url.toString(), options);
                if (!response.ok) {
                    throw new Error(`API エラー: ${response.status}`);
                }
                return response.json();
            }

            async loadPages() {
                try {
                    const result = await this.apiCall('getPages');
                    this.pages = result.pages || [];
                    this.render();
                } catch (error) {
                    console.error('ページ読み込みエラー:', error);
                    this.showError('ページの読み込みに失敗しました');
                }
            }

            async loadPage(pageId) {
                try {
                    const result = await this.apiCall('getPage', 'GET', { id: pageId });
                    this.currentPage = result.page;
                    this.title = result.page.title || '';
                    this.content = result.page.content || '';
                    this.isEditing = false;
                    this.render();
                } catch (error) {
                    console.error('ページ読み込みエラー:', error);
                    this.showError('ページの読み込みに失敗しました');
                }
            }

            async savePage() {
                try {
                    const pageData = {
                        id: this.currentPage?.id || Date.now().toString(),
                        title: this.title,
                        content: this.content
                    };

                    const result = await this.apiCall('savePage', 'POST', pageData);
                    
                    if (result.success) {
                        this.showSuccess('保存しました');
                        
                        await this.loadPages();
                        
                        if (!this.currentPage) {
                            this.currentPage = pageData;
                        }
                        
                        this.isEditing = false;
                        this.render();
                    }
                } catch (error) {
                    console.error('保存エラー:', error);
                    this.showError('保存に失敗しました');
                }
            }

            createNewPage() {
                if (!this.newPageTitle.trim()) return;
                
                this.currentPage = null;
                this.title = this.newPageTitle;
                this.content = '';
                this.isEditing = true;
                this.newPageTitle = '';
                this.render();
            }

            signIn() {
                if (this.authInstance) {
                    this.authInstance.signIn();
                }
            }

            signOut() {
                if (this.authInstance) {
                    this.authInstance.signOut();
                }
            }

            showSuccess(message) {
                this.statusMessage = message;
                this.render();
                setTimeout(() => {
                    this.statusMessage = '';
                    this.render();
                }, 3000);
            }

            showError(message) {
                this.statusMessage = `エラー: ${message}`;
                this.render();
                setTimeout(() => {
                    this.statusMessage = '';
                    this.render();
                }, 3000);
            }

            render() {
                const root = document.getElementById('root');
                
                if (!this.isAuthenticated) {
                    root.innerHTML = `
                        <div class="app-container">
                            <div class="login-container">
                                <h1>Notion風Wiki</h1>
                                <p>編集するにはGoogleアカウントでログインしてください</p>
                                <button class="btn btn-primary" id="signin-btn">
                                    Googleでログイン
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('signin-btn').onclick = () => this.signIn();
                    return;
                }

                root.innerHTML = `
                    <div class="app-container">
                        <!-- サイドバー -->
                        <div class="sidebar">
                            <div class="sidebar-header">
                                <div class="sidebar-title">ページ一覧</div>
                            </div>
                            
                            <ul class="page-list">
                                ${this.pages.map(page => `
                                    <li class="page-item ${this.currentPage?.id === page.id ? 'active' : ''}" 
                                        data-page-id="${page.id}">
                                        ${this.escapeHtml(page.title || '無題')}
                                    </li>
                                `).join('')}
                            </ul>
                            
                            <div class="new-page-form">
                                <input
                                    type="text"
                                    class="new-page-input"
                                    placeholder="新しいページタイトル"
                                    id="new-page-input"
                                />
                                <button class="btn btn-primary" id="add-page-btn">
                                    追加
                                </button>
                            </div>
                        </div>

                        <!-- メインコンテンツ -->
                        <div class="main-content">
                            <!-- ヘッダー -->
                            <div class="header">
                                <div class="header-title">
                                    ${this.currentPage ? (this.isEditing ? '編集中' : this.escapeHtml(this.currentPage.title || '無題')) : '新規ページ'}
                                </div>
                                <div class="header-actions">
                                    ${this.currentPage && !this.isEditing ? 
                                        '<button class="btn" id="edit-btn">編集</button>' : ''}
                                    ${this.isEditing ? `
                                        <button class="btn" id="cancel-btn">キャンセル</button>
                                        <button class="btn btn-primary" id="save-btn">保存</button>
                                    ` : ''}
                                    <button class="btn" id="signout-btn">ログアウト</button>
                                </div>
                            </div>

                            <!-- ステータスメッセージ -->
                            ${this.statusMessage ? `
                                <div class="status-message ${this.statusMessage.includes('エラー') ? 'status-error' : 'status-success'}">
                                    ${this.escapeHtml(this.statusMessage)}
                                </div>
                            ` : ''}

                            <!-- エディター/ビューアー -->
                            <div class="editor-container">
                                <div class="editor">
                                    ${this.isEditing ? `
                                        <input
                                            type="text"
                                            class="page-title"
                                            placeholder="無題"
                                            id="title-input"
                                            value="${this.escapeHtml(this.title)}"
                                        />
                                        <textarea
                                            class="editor-content"
                                            placeholder="何か書いてみましょう..."
                                            id="content-textarea"
                                        >${this.escapeHtml(this.content)}</textarea>
                                    ` : this.currentPage ? `
                                        <h1 class="page-title">${this.escapeHtml(this.currentPage.title || '無題')}</h1>
                                        <div class="viewer-content">${this.escapeHtml(this.currentPage.content || 'コンテンツがありません')}</div>
                                    ` : `
                                        <div class="viewer-content">ページを選択するか、新しいページを作成してください。</div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // イベントリスナーを設定
                this.setupEventListeners();
            }

            setupEventListeners() {
                // ページリストのクリック
                document.querySelectorAll('.page-item').forEach(item => {
                    item.onclick = () => {
                        const pageId = item.getAttribute('data-page-id');
                        this.loadPage(pageId);
                    };
                });

                // 新規ページ作成
                const newPageInput = document.getElementById('new-page-input');
                const addPageBtn = document.getElementById('add-page-btn');
                
                if (newPageInput && addPageBtn) {
                    newPageInput.onkeypress = (e) => {
                        if (e.key === 'Enter') {
                            this.newPageTitle = newPageInput.value;
                            this.createNewPage();
                        }
                    };
                    
                    addPageBtn.onclick = () => {
                        this.newPageTitle = newPageInput.value;
                        this.createNewPage();
                    };
                }

                // ヘッダーボタン
                const editBtn = document.getElementById('edit-btn');
                const cancelBtn = document.getElementById('cancel-btn');
                const saveBtn = document.getElementById('save-btn');
                const signoutBtn = document.getElementById('signout-btn');

                if (editBtn) editBtn.onclick = () => {
                    this.isEditing = true;
                    this.render();
                };

                if (cancelBtn) cancelBtn.onclick = () => {
                    this.isEditing = false;
                    this.title = this.currentPage?.title || '';
                    this.content = this.currentPage?.content || '';
                    this.render();
                };

                if (saveBtn) saveBtn.onclick = () => this.savePage();
                if (signoutBtn) signoutBtn.onclick = () => this.signOut();

                // エディター要素
                const titleInput = document.getElementById('title-input');
                const contentTextarea = document.getElementById('content-textarea');

                if (titleInput) {
                    titleInput.oninput = (e) => {
                        this.title = e.target.value;
                    };
                }

                if (contentTextarea) {
                    contentTextarea.oninput = (e) => {
                        this.content = e.target.value;
                    };
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // アプリケーションを起動
        document.addEventListener('DOMContentLoaded', () => {
            new WikiApp();
        });
    </script>
</body>
</html>
