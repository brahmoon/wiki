<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="./styles/editor.css">
    <!-- link rel="stylesheet" href="./styles/drive-image-modal.css" -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div id="editor-root">
        <div class="loading">ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <script type="module">
        import { Editor } from 'https://esm.sh/@tiptap/core'
        import StarterKit from 'https://esm.sh/@tiptap/starter-kit'
        import { Table } from 'https://esm.sh/@tiptap/extension-table'
        import { TableRow } from 'https://esm.sh/@tiptap/extension-table-row'
        import { TableHeader } from 'https://esm.sh/@tiptap/extension-table-header'
        import { TableCell } from 'https://esm.sh/@tiptap/extension-table-cell'
        import { Placeholder } from 'https://esm.sh/@tiptap/extension-placeholder'
        import Image from 'https://esm.sh/@tiptap/extension-image';
        import { DriveImageExtension } from 'https://brahmoon.github.io/wiki/extensions/driveImage/DriveImageExtension.js';
        
        let editor = null;
        
        function createToolbarButton(config) {
            const button = document.createElement('button');
            button.className = 'toolbar-button';
            button.innerHTML = config.content;
            button.title = config.title;
            
            if (config.onClick) {
                button.addEventListener('click', config.onClick);
            }
            
            return button;
        }
        
        function createSeparator() {
            const separator = document.createElement('div');
            separator.className = 'toolbar-separator';
            return separator;
        }
        
        function updateToolbarState() {
            if (!editor) return;

            // Undo/Redoãƒœã‚¿ãƒ³
            const undoBtn = document.querySelector('[data-command="undo"]');
            if (undoBtn) {
                undoBtn.disabled = !editor.can().undo();
            }
            
            const redoBtn = document.querySelector('[data-command="redo"]');
            if (redoBtn) {
                redoBtn.disabled = !editor.can().redo();
            }
            
            // å¤ªå­—ãƒœã‚¿ãƒ³
            const boldBtn = document.querySelector('[data-command="bold"]');
            if (boldBtn) {
                boldBtn.classList.toggle('active', editor.isActive('bold'));
            }
            
            // ã‚¤ã‚¿ãƒªãƒƒã‚¯ãƒœã‚¿ãƒ³
            const italicBtn = document.querySelector('[data-command="italic"]');
            if (italicBtn) {
                italicBtn.classList.toggle('active', editor.isActive('italic'));
            }
            
            // è¦‹å‡ºã—ãƒœã‚¿ãƒ³
            for (let i = 1; i <= 3; i++) {
                const headingBtn = document.querySelector(`[data-command="heading${i}"]`);
                if (headingBtn) {
                    headingBtn.classList.toggle('active', editor.isActive('heading', { level: i }));
                }
            }
            
            // å¼•ç”¨ãƒœã‚¿ãƒ³
            const quoteBtn = document.querySelector('[data-command="blockquote"]');
            if (quoteBtn) {
                quoteBtn.classList.toggle('active', editor.isActive('blockquote'));
            }
            
            // ãƒªã‚¹ãƒˆãƒœã‚¿ãƒ³
            const bulletBtn = document.querySelector('[data-command="bulletList"]');
            if (bulletBtn) {
                bulletBtn.classList.toggle('active', editor.isActive('bulletList'));
            }
            
            const orderedBtn = document.querySelector('[data-command="orderedList"]');
            if (orderedBtn) {
                orderedBtn.classList.toggle('active', editor.isActive('orderedList'));
            }
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³
            const tableBtn = document.querySelector('[data-command="insertTable"]');
            if (tableBtn) {
                tableBtn.disabled = editor.isActive('table');
            }
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
            updateTableButtons();
        }
        
        function updateTableButtons() {
            const tableButtons = document.querySelector('.table-buttons');
            if (!tableButtons) return;
            
            if (editor && editor.isActive('table')) {
                tableButtons.style.display = 'flex';
            } else {
                tableButtons.style.display = 'none';
            }
        }
        
        function createToolbar() {
            const toolbar = document.createElement('div');
            toolbar.className = 'toolbar';

            // å…ƒã«æˆ»ã™
            const undoBtn = createToolbarButton({
                content: 'â†¶',
                title: 'å…ƒã«æˆ»ã™',
                onClick: () => editor?.chain().focus().undo().run()
            });
            undoBtn.setAttribute('data-command', 'undo');
            toolbar.appendChild(undoBtn);
            
            // ã‚„ã‚Šç›´ã—
            const redoBtn = createToolbarButton({
                content: 'â†·',
                title: 'ã‚„ã‚Šç›´ã—',
                onClick: () => editor?.chain().focus().redo().run()
            });
            redoBtn.setAttribute('data-command', 'redo');
            toolbar.appendChild(redoBtn);
            
            // å¤ªå­—ãƒœã‚¿ãƒ³
            const boldBtn = createToolbarButton({
                content: '<strong>B</strong>',
                title: 'å¤ªå­—',
                onClick: () => editor?.chain().focus().toggleBold().run()
            });
            boldBtn.setAttribute('data-command', 'bold');
            toolbar.appendChild(boldBtn);
            
            // ã‚¤ã‚¿ãƒªãƒƒã‚¯ãƒœã‚¿ãƒ³
            const italicBtn = createToolbarButton({
                content: '<em>I</em>',
                title: 'ã‚¤ã‚¿ãƒªãƒƒã‚¯',
                onClick: () => editor?.chain().focus().toggleItalic().run()
            });
            italicBtn.setAttribute('data-command', 'italic');
            toolbar.appendChild(italicBtn);
            
            toolbar.appendChild(createSeparator());
            
            // è¦‹å‡ºã—1
            const h1Btn = createToolbarButton({
                content: 'H1',
                title: 'è¦‹å‡ºã—1',
                onClick: () => editor?.chain().focus().toggleHeading({ level: 1 }).run()
            });
            h1Btn.setAttribute('data-command', 'heading1');
            toolbar.appendChild(h1Btn);
            
            // è¦‹å‡ºã—2
            const h2Btn = createToolbarButton({
                content: 'H2',
                title: 'è¦‹å‡ºã—2',
                onClick: () => editor?.chain().focus().toggleHeading({ level: 2 }).run()
            });
            h2Btn.setAttribute('data-command', 'heading2');
            toolbar.appendChild(h2Btn);
            
            // è¦‹å‡ºã—3
            const h3Btn = createToolbarButton({
                content: 'H3',
                title: 'è¦‹å‡ºã—3',
                onClick: () => editor?.chain().focus().toggleHeading({ level: 3 }).run()
            });
            h3Btn.setAttribute('data-command', 'heading3');
            toolbar.appendChild(h3Btn);
            
            toolbar.appendChild(createSeparator());
            
            // å¼•ç”¨
            const quoteBtn = createToolbarButton({
                content: '"',
                title: 'å¼•ç”¨',
                onClick: () => editor?.chain().focus().toggleBlockquote().run()
            });
            quoteBtn.setAttribute('data-command', 'blockquote');
            toolbar.appendChild(quoteBtn);
            
            toolbar.appendChild(createSeparator());
            
            // ç®‡æ¡æ›¸ããƒªã‚¹ãƒˆ
            const bulletBtn = createToolbarButton({
                content: 'â€¢',
                title: 'ç®‡æ¡æ›¸ããƒªã‚¹ãƒˆ',
                onClick: () => editor?.chain().focus().toggleBulletList().run()
            });
            bulletBtn.setAttribute('data-command', 'bulletList');
            toolbar.appendChild(bulletBtn);
            
            // ç•ªå·ä»˜ããƒªã‚¹ãƒˆ
            const orderedBtn = createToolbarButton({
                content: '1.',
                title: 'ç•ªå·ä»˜ããƒªã‚¹ãƒˆ',
                onClick: () => editor?.chain().focus().toggleOrderedList().run()
            });
            orderedBtn.setAttribute('data-command', 'orderedList');
            toolbar.appendChild(orderedBtn);
            
            toolbar.appendChild(createSeparator());
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«æŒ¿å…¥
            const tableBtn = createToolbarButton({
                content: 'âŠ',
                title: 'ãƒ†ãƒ¼ãƒ–ãƒ«æŒ¿å…¥',
                onClick: () => editor?.chain().focus().insertTable({ rows: 3, cols: 3, withHeaderRow: true }).run()
            });
            tableBtn.setAttribute('data-command', 'insertTable');
            toolbar.appendChild(tableBtn);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£ãƒœã‚¿ãƒ³ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰
            const tableButtons = document.createElement('div');
            tableButtons.className = 'table-buttons';
            tableButtons.style.display = 'none';
            tableButtons.style.gap = '4px';
            
            // è¡Œã‚’ä¸‹ã«è¿½åŠ 
            const addRowAfterBtn = createToolbarButton({
                content: 'â†“+',
                title: 'è¡Œã‚’ä¸‹ã«è¿½åŠ ',
                onClick: () => editor?.chain().focus().addRowAfter().run()
            });
            tableButtons.appendChild(addRowAfterBtn);
            
            // åˆ—ã‚’å·¦ã«è¿½åŠ 
            const addColBeforeBtn = createToolbarButton({
                content: 'â†+',
                title: 'åˆ—ã‚’å·¦ã«è¿½åŠ ',
                onClick: () => editor?.chain().focus().addColumnBefore().run()
            });
            tableButtons.appendChild(addColBeforeBtn);
            
            // åˆ—ã‚’å³ã«è¿½åŠ 
            const addColAfterBtn = createToolbarButton({
                content: 'â†’+',
                title: 'åˆ—ã‚’å³ã«è¿½åŠ ',
                onClick: () => editor?.chain().focus().addColumnAfter().run()
            });
            tableButtons.appendChild(addColAfterBtn);
            
            // è¡Œã‚’å‰Šé™¤
            const deleteRowBtn = createToolbarButton({
                content: 'Râœ•',
                title: 'è¡Œã‚’å‰Šé™¤',
                onClick: () => editor?.chain().focus().deleteRow().run()
            });
            tableButtons.appendChild(deleteRowBtn);
            
            // åˆ—ã‚’å‰Šé™¤
            const deleteColBtn = createToolbarButton({
                content: 'Câœ•',
                title: 'åˆ—ã‚’å‰Šé™¤',
                onClick: () => editor?.chain().focus().deleteColumn().run()
            });
            tableButtons.appendChild(deleteColBtn);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
            const deleteTableBtn = createToolbarButton({
                content: 'âŠâœ•',
                title: 'ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤',
                onClick: () => editor?.chain().focus().deleteTable().run()
            });
            tableButtons.appendChild(deleteTableBtn);
            
            toolbar.appendChild(tableButtons);
            toolbar.appendChild(createSeparator());
            
            return toolbar;
        }
        
        function initializeEditor() {
            try {
                // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
                const container = document.createElement('div');
                container.className = 'editor-container';
                
                // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’ä½œæˆ
                const toolbar = createToolbar();
                container.appendChild(toolbar);
                
                // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é ˜åŸŸã‚’ä½œæˆ
                const editorContent = document.createElement('div');
                editorContent.className = 'editor-content';
                container.appendChild(editorContent);
                
                // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
                editor = new Editor({
                    element: editorContent,
                    extensions: [
                        StarterKit,
                        Table.configure({
                            resizable: true,
                        }),
                        TableRow,
                        TableHeader,
                        TableCell,
                        Placeholder.configure({
                            placeholder: 'ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...',
                        }),
                        Image.configure({
                            inline: false,
                            allowBase64: false,
                            HTMLAttributes: {
                                class: 'editor-image',
                                loading: 'lazy',
                            },
                        }),
                        DriveImageExtension.configure({
                            webAppUrl: 'https://script.google.com/macros/s/AKfycbwm5fbI1eHdZ5EjUBXgaNi4xZgjNZXQ0QdkTfv5K1WSlj25DNBQtrL-q0wRZZJeUQ6TVg/exec',

                            maxFileSize: 10 * 1024 * 1024,
                            allowedMimeTypes: [
                                'image/jpeg',
                                'image/png',
                                'image/gif',
                                'image/webp',
                                'image/svg+xml'
                            ],

                            uploadTimeout: 45000,
                            maxConcurrentUploads: 2,

                            gallaryTimeout: 20000,
                            gallaryCacheTimeout: 600000,

                            enablePasteUpload: true,
                            enableDropUpload: true,

                            addToToolbar: true,
                            toolbarButtonHTML: 'ğŸ“',
                            toolbarButtonTitle: 'Driveã‹ã‚‰ç”»åƒã‚’æŒ¿å…¥',
                            toolbarSelector: '.ProseMirror-menubar',
                            buttonClass: 'menubar-button',

                            debug: process.env.NODE_ENV === 'development'
                        }),
                    ],
                    content: '<p>ã“ã‚“ã«ã¡ã¯ï¼ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</p>',
                    onUpdate: ({ editor }) => {
                        console.log('Content updated:', editor.getHTML());
                    },
                    onCreate: () => {
                        console.log('Editor created successfully');
                        const driveExt = editor.extensionManager.extensions.find(
                            ext => ext.name === 'driveImage'
                        );

                        if (driveExt) {
                            const health = driveExt.healthCheck();
                            if (!health.healthy) {
                                console.log('DriveImage extension issues:', health.issues);
                            }
                        }
                        updateToolbarState();
                    },
                    onUpdate: () => {
                        updateToolbarState();
                    },
                    onSelectionUpdate: () => {
                        updateToolbarState();
                    },
                });
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã«ç½®ãæ›ãˆ
                const root = document.getElementById('editor-root');
                root.innerHTML = '';
                root.appendChild(container);
                
            } catch (error) {
                console.error('Editor initialization failed:', error);
                document.getElementById('editor-root').innerHTML = 
                    '<div class="loading">ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }
        
        // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeEditor);
        } else {
            initializeEditor();
        }
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ5ç§’å¾Œã«å¼·åˆ¶åˆæœŸåŒ–ï¼‰
        setTimeout(() => {
            const root = document.getElementById('editor-root');
            if (root && root.innerHTML.includes('èª­ã¿è¾¼ã¿ä¸­')) {
                console.warn('Editor initialization timed out');
                initializeEditor();
            }
        }, 5000);
    </script>
</body>
</html>
